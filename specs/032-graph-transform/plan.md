# Implementation Plan: GraphTransform — View-Based Graph Transformations

**Branch**: `032-graph-transform` | **Date**: 2026-02-23 | **Spec**: [spec.md](./spec.md)

**Input**: Feature specification from `specs/032-graph-transform/spec.md`. Design aligned with `proposals/graph-transform-porting-guide.md` and `../pattern-hs` reference. Implementation does not depend on GraphLens (see spec Clarifications).

---

## Summary

Port the GraphTransform layer from the Haskell reference into pattern-rs: introduce **GraphView** (view over a classified graph + GraphQuery), **materialize** (view → PatternGraph), **unfold** / **unfold_graph** (seed-based construction), categorized transformations (**map_graph**, **map_all_graph**, **filter_graph**, **fold_graph**), **map_with_context** (snapshot-based context-aware mapping), and **para_graph** / **para_graph_fixed** (topology-aware folding). All behavior must match the reference; Rust-specific choices (ownership, CategoryMappers struct, explicit fold init, iterative unfold) are documented in research.md. GraphView is built from PatternGraph only in this feature; the optional GraphLens constructor is deferred.

---

## Technical Context

**Language/Version**: Rust 1.70.0 (workspace MSRV), Edition 2021  
**Primary Dependencies**: `std` only — `HashMap`, `HashSet`, `Vec`, `Rc`/`Arc` (no new external crates); depends on 030-graph-classifier and 031-graph-query types  
**Storage**: N/A (in-memory; views and transformations over PatternGraph/GraphQuery)  
**Testing**: `cargo test` — unit tests + equivalence tests against pattern-hs where available  
**Target Platform**: Native Rust + wasm32-unknown-unknown + Python (via PyO3)  
**Project Type**: Library (pattern-core crate)  
**Performance Goals**: Correctness-first; eager Vec per transformation step; profile before iterator-based laziness  
**Constraints**: No blocking I/O; WASM-compatible; view-consuming transformations (single ownership)  
**Scale/Scope**: Single crate (pattern-core); new modules `graph/graph_view.rs`, `graph/transform/`, `pattern/unfold.rs` (or equivalent); ~8–12 new/updated source files

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|----------|--------|-------|
| I. Reference Fidelity | PASS | Port follows graph-transform porting guide and pattern-hs behavior; FR-015 requires alignment; equivalence tests in scope |
| II. Correctness & Compatibility | PASS | All operations match reference semantics; deviations (e.g. iterative unfold, CategoryMappers struct) documented in research.md |
| III. Rust Native Idioms | PASS | Ownership (view consumed by materialize/transforms), snake_case, explicit init for fold, `impl Fn` where possible |
| IV. Multi-Target Design | PASS | No blocking I/O; view/transform logic is pure; WASM and Python targets unchanged |
| V. Examples | PASS | quickstart.md provides runnable usage examples for view, materialize, unfold, map, filter, fold, map_with_context, para_graph |

No constitution violations. Complexity tracking section not needed.

---

## Project Structure

### Documentation (this feature)

```text
specs/032-graph-transform/
├── plan.md              # This file
├── research.md          # Phase 0 — design decisions, porting guide consolidation
├── data-model.md        # Phase 1 — types, entities, module layout
├── quickstart.md        # Phase 1 — usage examples
├── contracts/
│   └── public-api.md    # Phase 1 — public Rust API surface
└── tasks.md             # Phase 2 — generated by /speckit.tasks (not by /speckit.plan)
```

### Source Code (repository root)

```text
crates/pattern-core/
├── Cargo.toml
├── src/
│   ├── lib.rs                           update: re-export GraphView, transform, unfold
│   ├── pattern_graph.rs                 existing; GraphView built from PatternGraph via graph_view
│   ├── pattern/
│   │   ├── mod.rs                       update: re-export core + unfold
│   │   ├── core.rs                     NEW: moved from pattern.rs (existing Pattern type and impls)
│   │   └── unfold.rs                   NEW: unfold (anamorphism for Pattern tree)
│   └── graph/
│       ├── mod.rs                       update: re-export graph_view, transform
│       ├── graph_classifier.rs          existing (030)
│       ├── graph_query.rs               existing (031)
│       ├── graph_view.rs                NEW: GraphView, from_pattern_graph, from_graph_lens (placeholder), materialize
│       └── transform/
│           ├── mod.rs                   NEW: re-export all transform fns + Substitution, CategoryMappers
│           ├── types.rs                 NEW: Substitution<V>, CategoryMappers (if not inline)
│           ├── map_filter_fold.rs       NEW: map_graph, map_all_graph, filter_graph, fold_graph
│           ├── context.rs               NEW: map_with_context
│           ├── para.rs                  NEW: para_graph, para_graph_fixed
│           └── unfold_graph.rs          NEW: unfold_graph
└── tests/
    ├── graph_view.rs                    NEW: view construction, materialize round-trip
    ├── transform.rs                     NEW: map, filter, fold, map_with_context, para, unfold_graph
    └── equivalence/                    optional: shared tests vs pattern-hs
```

**Structure Decision**: Single project (Option 1). All code lives in `pattern-core`. GraphView and transform live under `graph/`; `unfold` for a single Pattern tree lives under `pattern/` per porting guide. No new crates. GraphLens is not required for this feature; from_graph_lens is a placeholder until a separate GraphLens feature is ported.

---

## Complexity Tracking

Not used — no constitution violations requiring justification.
