# Data Model: Testing Infrastructure

**Feature**: 003-test-infrastructure  
**Date**: 2025-01-27

## Overview

This document describes the data structures and entities used by the testing infrastructure. The testing infrastructure itself does not persist data, but it works with test data structures, test results, and test configurations.

## Entities

### Test Case

A structured test input and expected output used for validation.

**Attributes**:
- `name`: String identifier for the test case
- `description`: Human-readable description of what the test validates
- `input`: Test input data (type and value)
- `expected`: Expected output (type and value)
- `operations`: Optional list of operations to perform on the input

**Relationships**:
- Extracted from gram-hs or generated for property-based testing
- Used by equivalence checking utilities
- Stored in `tests/common/test_cases.json`

**Validation Rules**:
- Name must be unique within test case collection
- Input and expected must have valid types
- Operations must be valid for the input type

### Property Test Configuration

Configuration for property-based tests specifying generation parameters.

**Attributes**:
- `cases`: Number of test cases to generate (default: 256, minimum: 100 per SC-001)
- `max_size`: Maximum size/complexity of generated inputs
- `timeout`: Maximum time to spend on property validation
- `seed`: Optional random seed for reproducible tests

**Relationships**:
- Used by property-based test framework (proptest)
- Configured per test or globally

**Validation Rules**:
- Cases must be >= 100 (per SC-001)
- Max size must be positive
- Timeout must be positive

### Equivalence Check Result

Result of comparing outputs from gram-rs and gram-hs implementations.

**Attributes**:
- `test_case_name`: Name of the test case that was checked
- `equivalent`: Boolean indicating if outputs match
- `differences`: List of differences found (if not equivalent)
- `gram_rs_output`: Output from gram-rs implementation
- `gram_hs_output`: Output from gram-hs implementation (if available)
- `comparison_method`: Method used for comparison (test_data, direct, json)

**Relationships**:
- Generated by equivalence checking utilities
- Used for test reporting and debugging

**Validation Rules**:
- Differences list must be empty if equivalent is true
- At least one output must be present

### Snapshot

A captured output value stored for regression testing.

**Attributes**:
- `name`: Snapshot identifier
- `content`: Serialized output value
- `metadata`: Optional metadata (test name, timestamp, etc.)
- `format`: Serialization format (typically JSON or text)

**Relationships**:
- Stored in `tests/__snapshots__/` directories
- Compared against future test runs
- Managed by insta library

**Validation Rules**:
- Name must be valid filesystem identifier
- Content must be serializable
- Format must be supported by snapshot library

### Benchmark Result

Performance measurement from a benchmark run.

**Attributes**:
- `benchmark_name`: Name of the benchmark
- `operation`: Operation being benchmarked
- `iterations`: Number of iterations performed
- `duration`: Measured duration
- `throughput`: Optional throughput metric
- `variance`: Variance across runs (for consistency checking)

**Relationships**:
- Generated by criterion benchmark suite
- Used for performance tracking and regression detection

**Validation Rules**:
- Duration must be positive
- Variance should be <10% for consistency (per SC-006)
- Iterations must be positive

### Test Helper Context

Context information for test helper utilities.

**Attributes**:
- `pattern_a`: First pattern for comparison
- `pattern_b`: Second pattern for comparison
- `comparison_options`: Options for comparison (deep, shallow, ignore_fields, etc.)
- `validation_rules`: Rules for structure validation

**Relationships**:
- Used by test helper utilities
- Passed to comparison functions

**Validation Rules**:
- Patterns must be valid pattern structures (once defined in feature 004)
- Comparison options must be valid

## Data Flow

### Test Case Extraction Flow

```
gram-hs test files
    ↓
Extraction utilities
    ↓
JSON test case format
    ↓
tests/common/test_cases.json
    ↓
Equivalence checking / Test execution
```

### Property-Based Testing Flow

```
Property definition
    ↓
Test generator (proptest)
    ↓
Generated test inputs
    ↓
Property validation
    ↓
Test result (pass/fail with counterexample)
```

### Equivalence Checking Flow

```
Test case input
    ↓
    ├─→ gram-rs implementation → Output A
    └─→ gram-hs implementation → Output B
    ↓
Comparison utility
    ↓
Equivalence result (match/diff)
```

### Snapshot Testing Flow

```
Test execution
    ↓
Output generation
    ↓
Snapshot capture (insta)
    ↓
Comparison with stored snapshot
    ↓
Match or diff report
```

## State Transitions

### Snapshot Lifecycle

1. **Initial**: Snapshot does not exist
2. **Created**: First test run creates snapshot
3. **Verified**: Subsequent runs compare against snapshot
4. **Updated**: Developer accepts intentional changes
5. **Removed**: Snapshot deleted if test removed

### Test Case Lifecycle

1. **Extracted**: Test case extracted from gram-hs
2. **Validated**: Test case format validated
3. **Stored**: Test case stored in JSON file
4. **Used**: Test case used in equivalence checking
5. **Updated**: Test case updated if gram-hs changes

## Constraints

- Test cases must conform to JSON schema defined in `contracts/test-sync-format.md` (from feature 002)
- Snapshots must be serializable (patterns will need serde Serialize/Deserialize)
- Benchmark results must be reproducible (variance <10% per SC-006)
- Property test generators must produce valid pattern structures (once patterns are defined)
- Equivalence checking must handle approximate equality for floating-point values (if applicable)

## Dependencies on Other Features

- **Feature 002**: Test case JSON format, test synchronization infrastructure
- **Feature 004**: Pattern type definitions (needed for generators, helpers, snapshots)
- **Feature 005+**: Pattern operations (needed for property tests, benchmarks)

## Notes

- Pattern types are not yet defined (feature 004), so pattern-related structures are placeholders
- Test utilities will be designed to work with pattern types once they are available
- Snapshot serialization depends on pattern types implementing serde traits
- Property test generators require pattern type definitions to generate valid test inputs

